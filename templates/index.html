<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的错题本</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入 Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- 如果 CDN 加载失败，则回退到本地静态文件 -->
    <script>
        (function(){
            // 如果 Chart 未定义，尝试静默加载本地备份文件 static/vendor/chart.min.js
            if (typeof Chart === 'undefined') {
                var s = document.createElement('script');
                s.src = '/static/vendor/chart.min.js';
                s.async = true;
                s.onload = function(){ console.info('Loaded local Chart fallback'); };
                s.onerror = function(){ console.error('Failed to load Chart from CDN and local fallback.'); };
                document.head.appendChild(s);
            }
        })();
    </script>
    <!-- 引入 TinyMCE 富文本编辑器 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <div class="container">
        <h1>我的错题本</h1>

        <!-- ==================== 总结和图表区域 ==================== -->
        <div class="summary-section">
            <!-- 左侧：周度折线图 -->
            <div class="chart-container">
                <h2>近7日错题趋势</h2>
                <canvas id="weekly-chart"></canvas>
            </div>

            <!-- 【已修改】右侧：每日总结 (现在是一个动态容器) -->
            <div id="daily-summary-container" class="summary-content">
                {% if initial_summary_data %}
                <!-- 如果后端传来了初始数据，直接渲染 -->
                <h2>学习总结 ({{ initial_summary_data.date }})</h2>
                <button id="regenerate-summary-btn" class="secondary-btn" title="使用最新的AI模型重新生成总结">
                    🔄 重新生成
                </button>
                {% if initial_summary_data.ai_summary and not initial_summary_data.ai_summary.error %}
                    <p><strong>学习总纲：</strong>{{ initial_summary_data.ai_summary.general_summary }}</p>
                    <p><strong>核心知识点：</strong></p>
                    <ul>
                        {% for point in initial_summary_data.ai_summary.knowledge_points_summary %}
                        <li>{{ point }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="error-text">AI总结生成失败或不可用。</p>
                {% endif %}
                <div class="summary-stats">
                    <div class="stat-item"><strong>当日错题数：</strong> {{ initial_summary_data.question_count }} 道</div>
                    <div class="stat-item subject-chart-container"><strong>科目分布：</strong><canvas id="subject-bar-chart-dynamic"></canvas></div>
                </div>
                {% else %}
                <!-- 否则，显示占位符 -->
                <div class="placeholder">
                    <h2>学习总结</h2>
                    <p>请点击左侧日历中有记录的日期，查看对应日期的学习总结。</p>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- ==================== 总结区域结束 ==================== -->


        <!-- ==================== 主内容区域 ==================== -->
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="review-tab">错题回顾</button>
            <button class="tab-btn" data-tab="careless-mistake-tab">计算错误</button>
            <button class="tab-btn" data-tab="upload-tab">上传新题</button>
        </div>

        <!-- 主选项卡内容 -->
        <div class="tab-content">
            <!-- 1. 错题回顾面板 -->
            <div id="review-tab" class="tab-pane active">
                {% if subjects %}
                <div class="review-container">
                    <!-- 左侧日历导航 -->
                    <div id="calendar-container" class="timeline-nav">
                        <div id="calendar-header">
                            <button id="prev-month" title="上个月">&lt;</button>
                            <h3 id="month-year"></h3>
                            <button id="next-month" title="下个月">&gt;</button>
                        </div>
                        <div id="calendar-weekdays">
                            <div>一</div>
                            <div>二</div>
                            <div>三</div>
                            <div>四</div>
                            <div>五</div>
                            <div>六</div>
                            <div>日</div>
                        </div>
                        <div id="calendar-grid">
                            <!-- 日期将由JavaScript动态生成 -->
                        </div>
                    </div>

                    <!-- 右侧内容区 -->
                    <main class="content-area">
                        <!-- 科目子选项卡按钮 -->
                        <div class="subject-tab-buttons">
                            {% for subject in subjects %}
                            <button class="subject-btn {{ 'active' if loop.first }}" data-subject="{{ subject }}">{{ subject }}</button>
                            {% endfor %}
                        </div>

                        <!-- 科目子选项卡内容 (动态加载容器) -->
                        <div class="subject-tab-content">
                            {% for subject in subjects %}
                            <div id="subject-{{ subject }}" class="subject-pane {{ 'active' if loop.first }}" 
                                 data-subject-name="{{ subject }}" 
                                 data-page="1" 
                                 data-has-more="true" 
                                 data-is-loading="false">
                                <!-- 内容将由JavaScript动态加载 -->
                                <div class="loader">加载中...</div>
                            </div>
                            {% endfor %}
                        </div>
                    </main>
                </div>
                {% else %}
                <p style="text-align: center;">你的错题本还是空的，快去“上传新题”添加第一条记录吧！</p>
                {% endif %}
            </div>

            <!-- 2. 计算错误回顾面板 -->
            <div id="careless-mistake-tab" class="tab-pane" data-page="1" data-has-more="true" data-is-loading="false">
                <div class="careless-mistake-list">
                    <!-- 粗心错误内容将由JavaScript动态加载 -->
                </div>
                <div class="loader">加载中...</div>
            </div>

            <!-- 3. 上传错题面板 -->
            <div id="upload-tab" class="tab-pane">
                <!-- 上传区域的子选项卡 -->
                <div class="subject-tab-buttons upload-sub-tabs">
                    <button class="subject-btn active" data-sub-tab="ai-upload">AI智能分析</button>
                    <button class="subject-btn" data-sub-tab="careless-upload">我的粗心反思</button>
                </div>

                <!-- 子选项卡面板 -->
                <div class="upload-sub-panes">
                    <!-- 3.1 AI智能分析上传 -->
                    <div id="ai-upload" class="upload-pane active">
                        <form id="upload-form">
                            <div>
                                <label for="subject">科目:</label>
                                <input type="text" id="subject" name="subject" placeholder="例如：数学、物理" required>
                            </div>
                            <div>
                                <label for="user_question">自己的疑问 (可选):</label>
                                <textarea id="user_question" name="user_question" placeholder="可以告诉AI你的具体困惑，例如：为什么这条辅助线要这么画？"></textarea>
                            </div>
                            <div>
                                <label for="question_image">选择错题图片:</label>
                                <input type="file" id="question_image" name="question_image" accept="image/*" required>
                            </div>
                            <div id="image-preview"></div>
                            <button type="submit" id="submit-btn">上传并分析</button>
                            <div id="upload-status"></div>
                        </form>
                    </div>

                    <!-- 3.2 我的粗心反思上传 -->
                    <div id="careless-upload" class="upload-pane">
                        <form id="careless-upload-form">
                            <div>
                                <label for="careless_question_image">原题图片:</label>
                                <input type="file" id="careless_question_image" name="question_image" accept="image/*" required>
                            </div>
                            <div id="careless-image-preview"></div>
                            <div>
                                <label for="reflection-editor">我的反思:</label>
                                <textarea id="reflection-editor" name="user_reflection"></textarea>
                            </div>
                            <button type="submit" id="careless-submit-btn">保存我的反思</button>
                            <div id="careless-upload-status"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== 将后端数据传递给JavaScript ==================== -->
    <script>
        // 使用 tojson 过滤器安全地将Python数据转换为JavaScript对象
        const weeklyChartData = {{ weekly_chart_data | tojson }};
        const allDatesWithRecords = {{ all_dates | tojson }};
        // 【关键】将初始总结数据也传递给JS
        const initialSummaryData = {{ initial_summary_data | tojson }};
    </script>
    <!-- 拆分后的脚本：按依赖顺序加载（utils -> summary -> calendar -> tabs -> upload -> actions -> careless） -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/summary.js') }}"></script>
    <script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/upload.js') }}"></script>
    <script src="{{ url_for('static', filename='js/actions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/careless.js') }}"></script>
    
    <!-- 【新增】用于初始化页面加载时的每日总结图表（使用 ensureChartAvailable 防护并回退本地） -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (!initialSummaryData || !initialSummaryData.subject_chart_data) return;

        var initSubjectChart = function() {
            try {
                if (typeof Chart === 'undefined') { console.warn('Chart.js 未定义，无法渲染科目分布图'); return; }
                const ctx = document.getElementById('subject-bar-chart-dynamic');
                if (!ctx) return;
                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { 
                        labels: initialSummaryData.subject_chart_data.labels, 
                        datasets: [{ 
                            label: '科目错题数', 
                            data: initialSummaryData.subject_chart_data.data, 
                            backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)'], 
                            borderWidth: 1 
                        }] 
                    },
                    options: { 
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, 
                        plugins: { legend: { display: false } } 
                    }
                });
            } catch (e) { console.error('初始化科目分布图失败', e); }
        };

        if (window.ensureChartAvailable) {
            window.ensureChartAvailable(function() { initSubjectChart(); });
        } else {
            // 兜底：若 summary.js 未导出 ensureChartAvailable，则自行尝试本地回退加载再初始化
            if (typeof Chart !== 'undefined') { initSubjectChart(); }
            else {
                var s = document.createElement('script');
                s.src = '/static/vendor/chart.min.js';
                s.onload = initSubjectChart;
                s.onerror = function(){ console.error('无法加载本地 Chart 回退文件'); };
                document.head.appendChild(s);
            }
        }
    });
    </script>
</body>
</html>
