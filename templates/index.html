<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„é”™é¢˜æœ¬</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- å¼•å…¥ Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- å¦‚æœ CDN åŠ è½½å¤±è´¥ï¼Œåˆ™å›é€€åˆ°æœ¬åœ°é™æ€æ–‡ä»¶ -->
    <script>
        (function(){
            // å¦‚æœ Chart æœªå®šä¹‰ï¼Œå°è¯•é™é»˜åŠ è½½æœ¬åœ°å¤‡ä»½æ–‡ä»¶ static/vendor/chart.min.js
            if (typeof Chart === 'undefined') {
                var s = document.createElement('script');
                s.src = '/static/vendor/chart.min.js';
                s.async = true;
                s.onload = function(){ console.info('Loaded local Chart fallback'); };
                s.onerror = function(){ console.error('Failed to load Chart from CDN and local fallback.'); };
                document.head.appendChild(s);
            }
        })();
    </script>
    <!-- å¼•å…¥ TinyMCE å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ CDN -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„é”™é¢˜æœ¬</h1>

        <!-- ==================== æ€»ç»“å’Œå›¾è¡¨åŒºåŸŸ ==================== -->
        <div class="summary-section">
            <!-- å·¦ä¾§ï¼šå‘¨åº¦æŠ˜çº¿å›¾ -->
            <div class="chart-container">
                <h2>è¿‘7æ—¥é”™é¢˜è¶‹åŠ¿</h2>
                <canvas id="weekly-chart"></canvas>
            </div>

            <!-- ã€å·²ä¿®æ”¹ã€‘å³ä¾§ï¼šæ¯æ—¥æ€»ç»“ (ç°åœ¨æ˜¯ä¸€ä¸ªåŠ¨æ€å®¹å™¨) -->
            <div id="daily-summary-container" class="summary-content">
                {% if initial_summary_data %}
                <!-- å¦‚æœåç«¯ä¼ æ¥äº†åˆå§‹æ•°æ®ï¼Œç›´æ¥æ¸²æŸ“ -->
                <h2>å­¦ä¹ æ€»ç»“ ({{ initial_summary_data.date }})</h2>
                <button id="regenerate-summary-btn" class="secondary-btn" title="ä½¿ç”¨æœ€æ–°çš„AIæ¨¡å‹é‡æ–°ç”Ÿæˆæ€»ç»“">
                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                </button>
                {% if initial_summary_data.ai_summary and not initial_summary_data.ai_summary.error %}
                    <p><strong>å­¦ä¹ æ€»çº²ï¼š</strong>{{ initial_summary_data.ai_summary.general_summary }}</p>
                    <p><strong>æ ¸å¿ƒçŸ¥è¯†ç‚¹ï¼š</strong></p>
                    <ul>
                        {% for point in initial_summary_data.ai_summary.knowledge_points_summary %}
                        <li>{{ point }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="error-text">AIæ€»ç»“ç”Ÿæˆå¤±è´¥æˆ–ä¸å¯ç”¨ã€‚</p>
                {% endif %}
                <div class="summary-stats">
                    <div class="stat-item"><strong>å½“æ—¥é”™é¢˜æ•°ï¼š</strong> {{ initial_summary_data.question_count }} é“</div>
                    <div class="stat-item subject-chart-container"><strong>ç§‘ç›®åˆ†å¸ƒï¼š</strong><canvas id="subject-bar-chart-dynamic"></canvas></div>
                </div>
                {% else %}
                <!-- å¦åˆ™ï¼Œæ˜¾ç¤ºå ä½ç¬¦ -->
                <div class="placeholder">
                    <h2>å­¦ä¹ æ€»ç»“</h2>
                    <p>è¯·ç‚¹å‡»å·¦ä¾§æ—¥å†ä¸­æœ‰è®°å½•çš„æ—¥æœŸï¼ŒæŸ¥çœ‹å¯¹åº”æ—¥æœŸçš„å­¦ä¹ æ€»ç»“ã€‚</p>
                </div>
                {% endif %}
            </div>
        </div>
        <!-- ==================== æ€»ç»“åŒºåŸŸç»“æŸ ==================== -->


        <!-- ==================== ä¸»å†…å®¹åŒºåŸŸ ==================== -->
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="review-tab">é”™é¢˜å›é¡¾</button>
            <button class="tab-btn" data-tab="careless-mistake-tab">è®¡ç®—é”™è¯¯</button>
            <button class="tab-btn" data-tab="upload-tab">ä¸Šä¼ æ–°é¢˜</button>
        </div>

        <!-- ä¸»é€‰é¡¹å¡å†…å®¹ -->
        <div class="tab-content">
            <!-- 1. é”™é¢˜å›é¡¾é¢æ¿ -->
            <div id="review-tab" class="tab-pane active">
                {% if subjects %}
                <div class="review-container">
                    <!-- å·¦ä¾§æ—¥å†å¯¼èˆª -->
                    <div id="calendar-container" class="timeline-nav">
                        <div id="calendar-header">
                            <button id="prev-month" title="ä¸Šä¸ªæœˆ">&lt;</button>
                            <h3 id="month-year"></h3>
                            <button id="next-month" title="ä¸‹ä¸ªæœˆ">&gt;</button>
                        </div>
                        <div id="calendar-weekdays">
                            <div>ä¸€</div>
                            <div>äºŒ</div>
                            <div>ä¸‰</div>
                            <div>å››</div>
                            <div>äº”</div>
                            <div>å…­</div>
                            <div>æ—¥</div>
                        </div>
                        <div id="calendar-grid">
                            <!-- æ—¥æœŸå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- å³ä¾§å†…å®¹åŒº -->
                    <main class="content-area">
                        <!-- ç§‘ç›®å­é€‰é¡¹å¡æŒ‰é’® -->
                        <div class="subject-tab-buttons">
                            {% for subject in subjects %}
                            <button class="subject-btn {{ 'active' if loop.first }}" data-subject="{{ subject }}">{{ subject }}</button>
                            {% endfor %}
                        </div>

                        <!-- ç§‘ç›®å­é€‰é¡¹å¡å†…å®¹ (åŠ¨æ€åŠ è½½å®¹å™¨) -->
                        <div class="subject-tab-content">
                            {% for subject in subjects %}
                            <div id="subject-{{ subject }}" class="subject-pane {{ 'active' if loop.first }}" 
                                 data-subject-name="{{ subject }}" 
                                 data-page="1" 
                                 data-has-more="true" 
                                 data-is-loading="false">
                                <!-- å†…å®¹å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                                <div class="loader">åŠ è½½ä¸­...</div>
                            </div>
                            {% endfor %}
                        </div>
                    </main>
                </div>
                {% else %}
                <p style="text-align: center;">ä½ çš„é”™é¢˜æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œå¿«å»â€œä¸Šä¼ æ–°é¢˜â€æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ï¼</p>
                {% endif %}
            </div>

            <!-- 2. è®¡ç®—é”™è¯¯å›é¡¾é¢æ¿ -->
            <div id="careless-mistake-tab" class="tab-pane" data-page="1" data-has-more="true" data-is-loading="false">
                <div class="careless-mistake-list">
                    <!-- ç²—å¿ƒé”™è¯¯å†…å®¹å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
                </div>
                <div class="loader">åŠ è½½ä¸­...</div>
            </div>

            <!-- 3. ä¸Šä¼ é”™é¢˜é¢æ¿ -->
            <div id="upload-tab" class="tab-pane">
                <!-- ä¸Šä¼ åŒºåŸŸçš„å­é€‰é¡¹å¡ -->
                <div class="subject-tab-buttons upload-sub-tabs">
                    <button class="subject-btn active" data-sub-tab="ai-upload">AIæ™ºèƒ½åˆ†æ</button>
                    <button class="subject-btn" data-sub-tab="careless-upload">æˆ‘çš„ç²—å¿ƒåæ€</button>
                </div>

                <!-- å­é€‰é¡¹å¡é¢æ¿ -->
                <div class="upload-sub-panes">
                    <!-- 3.1 AIæ™ºèƒ½åˆ†æä¸Šä¼  -->
                    <div id="ai-upload" class="upload-pane active">
                        <form id="upload-form">
                            <div>
                                <label for="subject">ç§‘ç›®:</label>
                                <input type="text" id="subject" name="subject" placeholder="ä¾‹å¦‚ï¼šæ•°å­¦ã€ç‰©ç†" required>
                            </div>
                            <div>
                                <label for="user_question">è‡ªå·±çš„ç–‘é—® (å¯é€‰):</label>
                                <textarea id="user_question" name="user_question" placeholder="å¯ä»¥å‘Šè¯‰AIä½ çš„å…·ä½“å›°æƒ‘ï¼Œä¾‹å¦‚ï¼šä¸ºä»€ä¹ˆè¿™æ¡è¾…åŠ©çº¿è¦è¿™ä¹ˆç”»ï¼Ÿ"></textarea>
                            </div>
                            <div>
                                <label for="question_image">é€‰æ‹©é”™é¢˜å›¾ç‰‡:</label>
                                <input type="file" id="question_image" name="question_image" accept="image/*" required>
                            </div>
                            <div id="image-preview"></div>
                            <button type="submit" id="submit-btn">ä¸Šä¼ å¹¶åˆ†æ</button>
                            <div id="upload-status"></div>
                        </form>
                    </div>

                    <!-- 3.2 æˆ‘çš„ç²—å¿ƒåæ€ä¸Šä¼  -->
                    <div id="careless-upload" class="upload-pane">
                        <form id="careless-upload-form">
                            <div>
                                <label for="careless_question_image">åŸé¢˜å›¾ç‰‡:</label>
                                <input type="file" id="careless_question_image" name="question_image" accept="image/*" required>
                            </div>
                            <div id="careless-image-preview"></div>
                            <div>
                                <label for="reflection-editor">æˆ‘çš„åæ€:</label>
                                <textarea id="reflection-editor" name="user_reflection"></textarea>
                            </div>
                            <button type="submit" id="careless-submit-btn">ä¿å­˜æˆ‘çš„åæ€</button>
                            <div id="careless-upload-status"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== å°†åç«¯æ•°æ®ä¼ é€’ç»™JavaScript ==================== -->
    <script>
        // ä½¿ç”¨ tojson è¿‡æ»¤å™¨å®‰å…¨åœ°å°†Pythonæ•°æ®è½¬æ¢ä¸ºJavaScriptå¯¹è±¡
        const weeklyChartData = {{ weekly_chart_data | tojson }};
        const allDatesWithRecords = {{ all_dates | tojson }};
        // ã€å…³é”®ã€‘å°†åˆå§‹æ€»ç»“æ•°æ®ä¹Ÿä¼ é€’ç»™JS
        const initialSummaryData = {{ initial_summary_data | tojson }};
    </script>
    <!-- æ‹†åˆ†åçš„è„šæœ¬ï¼šæŒ‰ä¾èµ–é¡ºåºåŠ è½½ï¼ˆutils -> summary -> calendar -> tabs -> upload -> actions -> carelessï¼‰ -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/summary.js') }}"></script>
    <script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/upload.js') }}"></script>
    <script src="{{ url_for('static', filename='js/actions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/careless.js') }}"></script>
    
    <!-- ã€æ–°å¢ã€‘ç”¨äºåˆå§‹åŒ–é¡µé¢åŠ è½½æ—¶çš„æ¯æ—¥æ€»ç»“å›¾è¡¨ï¼ˆä½¿ç”¨ ensureChartAvailable é˜²æŠ¤å¹¶å›é€€æœ¬åœ°ï¼‰ -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (!initialSummaryData || !initialSummaryData.subject_chart_data) return;

        var initSubjectChart = function() {
            try {
                if (typeof Chart === 'undefined') { console.warn('Chart.js æœªå®šä¹‰ï¼Œæ— æ³•æ¸²æŸ“ç§‘ç›®åˆ†å¸ƒå›¾'); return; }
                const ctx = document.getElementById('subject-bar-chart-dynamic');
                if (!ctx) return;
                new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { 
                        labels: initialSummaryData.subject_chart_data.labels, 
                        datasets: [{ 
                            label: 'ç§‘ç›®é”™é¢˜æ•°', 
                            data: initialSummaryData.subject_chart_data.data, 
                            backgroundColor: ['rgba(255, 99, 132, 0.5)', 'rgba(54, 162, 235, 0.5)', 'rgba(255, 206, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(153, 102, 255, 0.5)', 'rgba(255, 159, 64, 0.5)'], 
                            borderWidth: 1 
                        }] 
                    },
                    options: { 
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, 
                        plugins: { legend: { display: false } } 
                    }
                });
            } catch (e) { console.error('åˆå§‹åŒ–ç§‘ç›®åˆ†å¸ƒå›¾å¤±è´¥', e); }
        };

        if (window.ensureChartAvailable) {
            window.ensureChartAvailable(function() { initSubjectChart(); });
        } else {
            // å…œåº•ï¼šè‹¥ summary.js æœªå¯¼å‡º ensureChartAvailableï¼Œåˆ™è‡ªè¡Œå°è¯•æœ¬åœ°å›é€€åŠ è½½å†åˆå§‹åŒ–
            if (typeof Chart !== 'undefined') { initSubjectChart(); }
            else {
                var s = document.createElement('script');
                s.src = '/static/vendor/chart.min.js';
                s.onload = initSubjectChart;
                s.onerror = function(){ console.error('æ— æ³•åŠ è½½æœ¬åœ° Chart å›é€€æ–‡ä»¶'); };
                document.head.appendChild(s);
            }
        }
    });
    </script>
</body>
</html>
